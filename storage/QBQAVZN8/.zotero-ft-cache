Particle mesh Ewald: An N⋅log(N) method for Ewald sums in large systems
Cite as: J. Chem. Phys. 98, 10089 (1993); https://doi.org/10.1063/1.464397 Submitted: 05 March 1993 • Accepted: 14 April 1993 • Published Online: 31 August 1998 Tom Darden, Darrin York and Lee Pedersen
ARTICLES YOU MAY BE INTERESTED IN Enhanced sampling in molecular dynamics The Journal of Chemical Physics 151, 070902 (2019); https://doi.org/10.1063/1.5109531 A general purpose model for the condensed phases of water: TIP4P/2005 The Journal of Chemical Physics 123, 234505 (2005); https://doi.org/10.1063/1.2121687 A modified TIP3P water potential for simulation with Ewald summation The Journal of Chemical Physics 121, 10096 (2004); https://doi.org/10.1063/1.1808117

J. Chem. Phys. 98, 10089 (1993); https://doi.org/10.1063/1.464397 © 1993 American Institute of Physics.

98, 10089

Particle mesh Ewald: An N -log(N) method for Ewald sums in large systems
Tom Darden, Darrin York, and Lee Pedersen National Institute ofEnvironmental Health Sciences, Research Triangle Park, North Carolina 27709
(Received 5 March 1993; accepted 14 April 1993)
An N ·log(N) method for evaluating electrostatic energies and forces of large periodic systems is presented. The method is based on interpolation of the reciprocal space Ewald sums and evaluation of the resulting convolutions using fast Fourier transforms. Timings and accuracies are presented for three large crystalline ionic systems.

INTRODUCTION
We consider a lattice A defined by elementary translation vectors al' a2' and a3 with Euclidean lengths al. a2. and a3, respectively. The Cartesian components of the kth lattice vector. ak. are denoted ak[ (1= 1.2.3). The conjugate
* reciprocal lattice A is defined by elementary translations
at • a~ • and a~ • with Euclidean lengths at • a~ • and a~. and Cartesian components a~[ (k.Z= 1,2,3). These reciprocal translations satisfy at· a{=8k{ (k.l= 1.2.3). The unit cell U of the lattice A consists of all points r having fractional coordinates (fl' f2. f3) with -~<fk,;d, for k= 1,2,3 (wherefk=at· r).
We define the functions <I>dir(r;{3) and <I>rec(r;f3). where r is a point in U and {3 is a positive number. by
and

where erfc(x) is the complementary error function, V=al . a2Xa3 is the volume of the unit cell U, and nand m
are given by n=nlal +n2a2+n3a3' and m=mlaT +m2a~+m3a~, for integers nk and mk (k=I,2,3). The effect of {3 on the Ewald pair potential, 'I/J(r;{3), defined by
'I/J(r) = <I>dir(r;{3) +<I>rec(r;{3), is that of an additive con-
stant. Hence. for a neutral system. the total electrostatic energy (and its derivatives) are invariant to {3.
The infinite series defining <I>dir and <I>rec are both rapidly convergent. Their rates of convergence are controlled by adjusting the value of {3. If {3 is chosen so that only the minimum image terms in the direct space sum <I>dir(r;f3) are retained, the total electrostatic energy of a neutral unit cell U, containing N point charges Ql>Q2,...,qN, located at positions rl'r2 •...•rN' is given byl-3

1N N

L L +2"

Qllj<I>rec(rj-r;;{3) +J(D),

(2)

i=1 j=1

J. Chern. Phys. 98 (12), 15 June 1993

where rij is the minimum image distance. De Leeuw et al. I derived the fourth term J(D) in Eq. (2), which depends quadratically on the dipole moment D of the unit cell, as well as the macroscopic boundary conditions of the crystal and the external dielectric constant.
Choosing {3 as above makes evaluation of the electro-
static energy an order N2 computational problem. Adjust-
ing {3 to optimize computational effort results in an order N 3/ 2 algorithm.4 Although conventional Ewald summation is widely used for simulations of small periodic systems. the computational cost becomes prohibitive for large (N
> 104) macromolecular simulations. Alternative tech-
niques for improving the evaluation of long range electrostatic forces include expansion of the Ewald pair potential in cubic polynomials.S table lookup of the pair potential.6 use of Wigner potentials,7 multiple time step ("twin range") methods,S particle-mesh techniques,9 and efficient Taylor and/or multipole expansions.lO-IS
The particle-mesh Ewald (PME) method presented here involves choosing {3 sufficiently large that atom pairs
for which rij exceeds a specified cutoff (e.g., 9 A..) are neg-
ligible in the direct space sum in Eq. (2) which reduces this term to order N. The reciprocal space sum in Eq. (2) is then approximated by a multidimensional piecewiseinterpolation approach inspired by the particle-mesh method of Hockney and Eastwood.9 The approximate reciprocal energy and forces are expressed as convolutions and can thus be evaluated quickly using fast Fourier transforms (FFTs). The resulting algorithm is of order N In (N), is easily programmed, and is shown below to be efficient and accurate for macromolecular systems.
METHOD
If <I>rec(r;{3) is expressed in fractional coordinates {Ii} we have
X exp [21Ti(mdl +mz!2+m3f3)].
(3)
Given positive integers K I , K 2, andK3 , we compute <I>rec as well as its (Cartesian) gradient on the grid of fractional coordinates (IlK!, lz/Kz, 13/K3), for Ik=I, ...,Kk,
10089

10090

Letters to the Editor

k= 1,2,3, and store these quantities into arrays at the beginning of the simulation. Given a pair of atoms i and j, with fractional coordinates fik and fh' k= 1,2,3, the in-

terpolation approximation (order p) to the reciprocal space pair potential, <l>ree,p, at each point is given in terms of the precomputed array values of <Pree ,

(4)

where the functions (}p,K are obtained from the barycentric form of the weights used in (2p-l)th order Lagrangian interpolation using the grid of points (kIK) , k E z.16 More specifically, for real argument x, let [x] denote the largest integer less than or equal to x, and define the in-
terger function kp,K(X) by kp,K(X) = [Kx] -p+ 1. Next de-
fine tPp,K(x,k) by

"l!.o'( -1)'<1'-') (x-1~) for 0<k<2p-1

=0 otherwise,

(5)

and finally let (}p,K(x,k) =tPp,K[x-kp,K(X),k-kp,K(X)]. Note that (}p,K(x,k) is nonzero for 2p values of k, and that the sum of (}p,K(x,k) over all k is unity. Since (}p,K(kIK,k) = 1 and (}p,K(iIK,k) =0 for l=l=k, we see that (}p,K(x,k) are continuous in x. Note also that x is always in the central grid interval, with respect to the weights, so that we avoid the ill-conditioning associated with high order polynomial interpolation. The approximate gradient is obtained by replacing <Pree in Eq. (4) by its gradient, obtained by term-by-term differentiation, at each grid point.
Defining Q at the grid points by

'" (~!2.~) (ll-kl 12-k2 13- k3)
Il'£I.2JI' 3 Q K I 'K2 'K3 <Pree K I ' K 2 ' K 3

kl k2 k3) . <Pree*Q ( KI' K2 'K3 '

(7)

where <Pree*Q denotes the discrete convolution operator,
and we have used the fact that <pree (r;f3) = <pree( -r;f3).
Since (}p,K(x,k) is continuous in x, the approximate energies and forces will be continuous with respect to particle position, which is not true of the cell multipole methods. 10-15 We can evaluate <Pree*Q using the fast Fourier transform in order KIK2K3 log (KIK 2K 3) steps, whereas evaluation of Q and Eree,pCi), i= 1,...,N can be achieved in order (2p) 2 • N steps. Similar results hold for evaluation of the gradient. In practice, we pack <Pree and its three gradient components at the grid points into two complex arrays
and precompute their Fourier transform (FT) once at the start of the simulation. At each subsequent step we compute Q as a complex array, transform it, multiply the trans-
formed components by the precomputed complex arrays at each grid point, and then back transform the resulting pair of complex arrays.
An upper bound for the absolute error I<I>ree,p - <Pree I can be estimated as follows. Given integers m, and K> 0, from standard error estimates on Lagrangian interpolationl6 we have for all x
lexp(21Timx)- L exp(21Tim~)(}p'K(X'k)1 keZ

(8)

the expression for the approximate reciprocal sum energy Eree,pU) at atom i due to the atoms of the unit cell U is

From Eqs. (4) and (8) we see that, pointwise

(2P) A

I

exp( _~m21f32)

I I<Pre,ep-<prec,pl <4 P1T-V moFO

m2

P

P

P

+ + ml )2
X [ ( 4KI

(m2 )2 4K2

( m3 )2 ] 4K3 .

(9)

The right hand side of Eq. (9) can be estimated by replacing the sum by an integral. We can change variables

J. Chern. Phys., Vol. 98, No. 12, 15 June 1993

Letters to the Editor

TABLE I. The relative potential error (nnsE), relative force error (nnsf), and maximum relative force error (maxerrf) are: nnsE=[(E-E)2/.wj1l2, nnsf=[~f(fi-f)2/~ffilll2, and maxerrf
=max{[(fi-fi)2/f;jl12; l.;;;i.;;N}; where E is the total electrostatic energy and fl is the force vector at atom
i, evaluated using the exact Ewald pair potential for all atom pairs. The" A" symbol indicates the
approximate values evaluated with the PME method using a 9 A atom-based list for the direct space contribution. The percent overhead (% overhead) is: timePME/timeCoulombX 100%; where timePME is the
time for evaluation of the total nonbond potential energy and forces usiitg the PME method for the electrostatics, and timeCoulomb is the time (2.28 s for B-DNA) required for evaluation of the total nonbond
energy and forces using conventional Coulombic interactions.

Order p
2 3 4

InnsE Innsf Imaxerrf 1% overhead
InnsE Irmsf Imaxerrf 1% overhead
InnsE Irmsf Imaxerrf 1% overhead
InnsE Irmsf Imaxerrf 1% overhead

Approximate grid size (A)/Dimensions (K1.K2,K3)

1.0

0.75

0.5

(24,40,64)

(32,54,96)

(48,81,128)

4.9XlO-3 2.9XI0-2 0.50 16.2%

3.1 X 10- 3 1.4 X 10-2 0.36 21.5%

2.0XIo- 3 7.5xlO-3 0.17 39.9%

l.4x 10-3 4.0xI0-3 0.13 21.5%

4.3x 10-4 1.1 X 10-3 2.8XlO-2 26.8%

1.1 X 10-4 2.6XlO-4 6.1 X 10-3
45.2%

5.0XlO-4 LOX 10-3 4.3xI0-2
35.5%

9.1 X 10-5 1.6X 10-4 3.4XlO-3
39.9%

1.1 X 10- 5 1.9X 10-5 4.0XIO-4
58.3%

2.2X 10-4 3.7XlO-4 1.6x 10-2
62.2%

2.5XIO-5 3.7XlO-5 7.4 X 10-4
64.9%

1.7 X 10- 6 5.7XIO-6 1.5 X 10-4
83.8%

10091

in the integral by xk=aflJnl+a!km2+arkm3' and mk =aklxl+ak2x2+ak3x3, for k=I,2,3. If we then transform to spherical coordinates, and apply the Cauchy-Schwarz inequality to the quanitities mkt k= 1,2,3, we see, using standard results on the moments of Gaussian distributions,17 that the right hand side ofEq. (9) is bounded from above by

8 ( 2P ) p

(2p)! p!

£.J;.

(!!...)2P[(~)2P +

(a2

)2p

+(

a3

P )2 ].

81T KI

K2

K3

(10)

A similar result can be obtained for the gradient. The error in the interpolation can be made arbitrarily small by
fixing al/KI, a2/K2, and a3/K3 to be less than one, and then choosing p sufficiently large. Thus, the quantity KIK2K3 is of order the system size ala2a3 and hence of order N, for any desired tolerance, and so the proposed algorithm is of order N log (N).

RESULTS
The PME method was implemented by modifying the AMBER3.0 (Rev. A) molecular dynamics code in the following way. The direct space pair potential, cI>dir> was computed along with the van der Waals and H-bond terms from an atom-based nonbond list. The erfc(x) function and its derivative were obtained by table look up (relative error <1.0x 10-8) for increased efficiency. The approximate reciprocal space pair potential <i>rec was evaluated as described above in a separate routine. An additional cor-

rection was needed to account for exclusion of nearest im-
ages of masked atom pairs (bonded pairs, etc.). All tests
were run as single processor jobs on the Cray YMP at the Frederick Cancer Research and Development Center.
The accuracy and computational efficiency of the PME
method were tested on several macromolecular crystals.
Unit cells were constructed from the space groups using the crystallographic coordinates for the heavy atom positions, as in previous work. 18,19 Point charges were assigned using the AMBER force field.2o Electrostatic energies and
forces for each atom are compared to the corresponding
values calculated using the exact Ewald pair potential (relative accuracy < 1X 10- 7).
Table I shows the results for an ionic B-DNA crystal.21 Results are given for grid densities (a l/K1 xa2/K2
Xa3/K3)1/3 of approximately 1.0, 0.75, and 0.5 A, and
interpolation order p= 1,2,,3,4. The computational cost of the PME method is compared to that of normal evaluation
of nonbond interactions using a 9 A atom-based Verlet list
on a single processor Cray YMP. The overhead above normal nonbond interactions ranges from approximately 16%
to 84% corresponding to root mean square (rms) relative force errors of 2.9 X 10-2 and 5.7 X 10-6, respectively. We conclude that reasonable relative accuracy (about 2 X 10-4
rms force error) can be obtained with approximately a
40% overhead, by using triquintic interpolation (p = 3) on a 0.75 A grid. Similar accuracies and computational costs
are obtained for large protein crystals22,23 using compara-
ble grid densities and interpolation orders (Table II). Note

J. Chern. Phys., Vol. 98, No. 12, 15 June 1993

10092

Letters to the Editor

TABLE II. Accuracy and timings for several crystal unit cells. Triquintic interpolation (p= 3) was used for each system. In each case {3 was chosen to be 0.386.

B-DNA (Ref. 21)

HIV-l PR (Ref. 22)

p21 (Ref. 23)

Space group
a,b,c (A)

P212121

P4 12 12

P3 221

24.87,40.39,66.20 50.24,50.24,106.56 40.3,40.3,162.2

a,{3,r C)

90,90,90

90,90,90

90,90,120

No. of atoms Approximate

7938
0.75 A

29661
0.84 A

25797
0.80 A

grid size

Grid dimensions (32,54,96)

(64,64,128 )

( 48,48,192)

(Kl ,K2 ,K3 ) rmsE
rmsf maxerrf

9.1 X 10-5 1.6x 10-4 3.4x 10-3

3.6XlO-5 1.6X 10-4 1.2 X 10-2

4.9XlO-5 2.3XlO-4 I.4X 10-2

timePME

3.19 s

10.76 s

9.46 s

% overhead 39.9%

39.0%

43.3%

the PME method is completely general to nonorthogonal unit cells.
Traditional particle-mesh techniques have been criticized as not being able to attain high accuracy efficiently, especially for nonuniform particle distributions. 11 Our results indicate that high precision (rms relative force error < 1.0 X 10-5) is easily obtained for macromolecular systems by using higher order interpolation with only a modest increase in computational time. Although the PME method has increased memory requirements over conventional nonbond list-based methods, the cost of memory appears to be rapidly decreasing, and hence may not be an issue in the future.
The PME method offers several advantages as a method for the treatment of long-range forces in macromolecular systems. These include
(1) High accuracy: High accuracy (z 5X 10-6 relative force) can be obtained with relatively little increase in computational effort.
(2) East o/implementation: The PME method can be efficiently implemented into conventional MD algorithms such as AMBER which use a Verlet list.
(3) Continuity: The PME pair potential and its derivatives are continuous functions of position, regardless of the accuracy required, and thus avoid problems involved with integration of discontinuous functions.
(4) Efficiency: The PME method is fast. For large macromolecular systems, the PME method requires only

about a 40% overhead over conventional truncated listbased methods to obtain relative force accuracies of z2 X 10-4•
The FORTRAN subroutines for performing the PME approximate energies and forces are available upon request from the authors.
ACKNOWLEDGMENTS
Tom Darden would like to acknowledge a very helpful conversation with Dr. Kevin E. Schmidt. Darrin York would like to acknowledge the UNC Medical School for support through the M.D.-Ph.D. program. We would like to acknowledge the Frederick National Cancer Institute Research and Development Center for the use of their Cray YMP while this code was being developed.
1S. W. De Leeuw, J. W. Perram, and E. R. Smith, Proc. R. Soc. London, Ser. A 373, 27 (1980). 2E. R. Smith, Proc. R. Soc. London, Ser. A 375,475 (1981). 3M. P. Allen and D. J. Tildesley, Computer Simulations ofLiquids (Oxford University, New York, 1987). 4N. Karasawa and W. A. Goddard, J. Phys. Chern. 93, 7320 (1989). 5D. Adams and G. Dubey, J. Comput. Phys. 72, 156 (1987). 6p. E. Smith and B. M. Pettitt, J. Chern. Phys. 95, 8430 (1991). 7B. Cichocki, B. U. Felderhof, and K. Hinsen, Phys. Rev. A 39, 5350 (1989). sH. Berendsen, in Molecular Dynamics and Protein Structure, edited by J. Hermans (Polycrystal Book Service, Western Springs, Illinois, 1985). 9R. W. Hockney and J. W. Eastwood, Computer Simulation Using Particles (McGraw-Hill, New York, 1981). lOB. Brooks, R. Bruccoleri, B. 0lafsen, D. States, S. Swaminathan, and M. Karplus, J. Comput. Chern. 4, 187 (1983). ilL. Greengard and V. Rokhlin, J. Comput. Phys. 73,325 (1987). 12K. E. Schmidt and M. A. Lee, J. Stat. Phys. 63, 1223 (1991). 13 J. A. Board, Jr., J. W. Causey, J. F. Leathrum, Jr., A. Windemuth, and K. Schulten, Chern. Phys. Lett. 198, 89 (1992). 14H._Q. Ding, N. Karasawa, and W. A. Goddard III, J. Chern. Phys. 97, 4309 (1992). lsF. S. Lee and A. Warshel, J. Chern. Phys. 97, 3100 (1992). 16p. Henrici, Essentials ofNumerical Analysis (Wiley, New York, 1982). 17M. Kendall and A. Stuart, The Advanced Theory of Statistics, Vol. 4, 4th ed. (MacMillan, New York, 1977). ISC. Foley, L. Pedersen, P. Charifson, T. Darden, W. Wittinghofer, E. Pai, and M. Anderson, Biochemistry 31, 4951 (1992). 19D. York, T. Darden, L. Pedersen, and M. Anderson, Biochemistry 32, 1143 (1993). 20S. Weiner, P. Kollman, D. Nguyen, and D. Case, J. Comput. Chern. 7, 230 (1986). 21 H. R. Drew, R. M. Wing, T. Takano, C. Broka, S. Tanaka, K. Itakura, and R. E. Dickerson, Proc. Natl. Acad. Sci. USA 78,2179 (1981). 22 A. Wlodawer, M. Miller, M. Jaskolski, B. K. Sathyanarayana, E. Baldwin, I. T. Weber, L. M. Selk, L. Clawson, J. Schneider, and S. B. H. Kent, Science 245, 616 (1989). 23E. F. Pai, U. Krengel, G. A. Petsko, R. S. Goody, W. Kabsch, and A. Wittinghofer, EMBO J. 9, 2351 (1990).

J. Chern. Phys., Vol. 98, No. 12, 15 June 1993

